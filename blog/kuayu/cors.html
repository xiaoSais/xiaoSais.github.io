<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>跨域资源共享（cors） | Secret</title>
    <meta name="description" content="Just playing around">
    <meta name="generator" content="VuePress 1.3.1">
    
    
    <link rel="preload" href="/assets/css/0.styles.aee194d5.css" as="style"><link rel="preload" href="/assets/js/app.e11a16b2.js" as="script"><link rel="preload" href="/assets/js/2.405cebda.js" as="script"><link rel="preload" href="/assets/js/36.95f54780.js" as="script"><link rel="prefetch" href="/assets/js/10.c30585d1.js"><link rel="prefetch" href="/assets/js/11.2fb492b5.js"><link rel="prefetch" href="/assets/js/12.4ce3828a.js"><link rel="prefetch" href="/assets/js/13.b7ba9b2d.js"><link rel="prefetch" href="/assets/js/14.0bf1f2b9.js"><link rel="prefetch" href="/assets/js/15.0f64fc68.js"><link rel="prefetch" href="/assets/js/16.ed96dff6.js"><link rel="prefetch" href="/assets/js/17.ec348c71.js"><link rel="prefetch" href="/assets/js/18.db1b9aa0.js"><link rel="prefetch" href="/assets/js/19.2119ca99.js"><link rel="prefetch" href="/assets/js/20.421983e6.js"><link rel="prefetch" href="/assets/js/21.89882d03.js"><link rel="prefetch" href="/assets/js/22.4354cee5.js"><link rel="prefetch" href="/assets/js/23.e98422f5.js"><link rel="prefetch" href="/assets/js/24.64903d0f.js"><link rel="prefetch" href="/assets/js/25.6b0f62f2.js"><link rel="prefetch" href="/assets/js/26.3167e0b9.js"><link rel="prefetch" href="/assets/js/27.87fca6b4.js"><link rel="prefetch" href="/assets/js/28.9679f207.js"><link rel="prefetch" href="/assets/js/29.6922ef3d.js"><link rel="prefetch" href="/assets/js/3.b0c069e6.js"><link rel="prefetch" href="/assets/js/30.d939c463.js"><link rel="prefetch" href="/assets/js/31.f7dfaa09.js"><link rel="prefetch" href="/assets/js/32.1adb14ce.js"><link rel="prefetch" href="/assets/js/33.80fd4dc1.js"><link rel="prefetch" href="/assets/js/34.5489d530.js"><link rel="prefetch" href="/assets/js/35.0f6b6028.js"><link rel="prefetch" href="/assets/js/37.f8cb9cb2.js"><link rel="prefetch" href="/assets/js/38.2bb255cd.js"><link rel="prefetch" href="/assets/js/39.54a4d20e.js"><link rel="prefetch" href="/assets/js/4.eaa24ed2.js"><link rel="prefetch" href="/assets/js/40.fc2cbac6.js"><link rel="prefetch" href="/assets/js/41.3c407481.js"><link rel="prefetch" href="/assets/js/5.a62e1c37.js"><link rel="prefetch" href="/assets/js/6.bdef66e2.js"><link rel="prefetch" href="/assets/js/7.17c555f8.js"><link rel="prefetch" href="/assets/js/8.ffccb86b.js"><link rel="prefetch" href="/assets/js/9.7ffd6f2e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.aee194d5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Secret</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/blog/document/swiper.html" class="nav-link">
  技术文档
</a></div><div class="nav-item"><a href="https://google.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  External
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/blog/document/swiper.html" class="nav-link">
  技术文档
</a></div><div class="nav-item"><a href="https://google.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  External
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>技术文档</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>深入axios</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Express</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Node.js</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>跨域</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/kuayu/tongyuan.html" class="sidebar-link">同源策略</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/kuayu/tongyuan.html#ajax-请求" class="sidebar-link">ajax 请求</a></li><li class="sidebar-sub-header"><a href="/blog/kuayu/tongyuan.html#dom-无法共享" class="sidebar-link">DOM 无法共享</a></li><li class="sidebar-sub-header"><a href="/blog/kuayu/tongyuan.html#cookie-无法共享" class="sidebar-link">Cookie 无法共享</a></li></ul></li><li><a href="/blog/kuayu/jsonp.html" class="sidebar-link">深入理解 Jsonp</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/kuayu/jsonp.html#同源策略" class="sidebar-link">同源策略</a></li><li class="sidebar-sub-header"><a href="/blog/kuayu/jsonp.html#jsonp-跨域" class="sidebar-link">Jsonp 跨域</a></li></ul></li><li><a href="/blog/kuayu/cors.html" class="active sidebar-link">跨域资源共享（cors）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/kuayu/cors.html#简介" class="sidebar-link">简介</a></li><li class="sidebar-sub-header"><a href="/blog/kuayu/cors.html#简单请求" class="sidebar-link">简单请求</a></li><li class="sidebar-sub-header"><a href="/blog/kuayu/cors.html#预检请求" class="sidebar-link">预检请求</a></li><li class="sidebar-sub-header"><a href="/blog/kuayu/cors.html#带-cookie-的预检请求" class="sidebar-link">带 cookie 的预检请求</a></li><li class="sidebar-sub-header"><a href="/blog/kuayu/cors.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/blog/kuayu/other.html" class="sidebar-link">其他跨域策略</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/kuayu/other.html#共享-cookie" class="sidebar-link">共享 Cookie</a></li><li class="sidebar-sub-header"><a href="/blog/kuayu/other.html#iframe-跨域" class="sidebar-link">Iframe 跨域</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>学习轨迹</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>散文随笔</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="跨域资源共享（cors）"><a href="#跨域资源共享（cors）" class="header-anchor">#</a> 跨域资源共享（cors）</h1> <h2 id="简介"><a href="#简介" class="header-anchor">#</a> 简介</h2> <p>首先 cors 是在 IE 10 + 浏览器上才可以工作。<b>并且前端不用做任何改造。</b> cors 允许你跨域去访问一个接口，只是后端要做些许调整。cors 将 client 的http 请求分为两种 简单请求 &amp;&amp; 预检请求。</p> <h2 id="简单请求"><a href="#简单请求" class="header-anchor">#</a> 简单请求</h2> <p>符合以下条件的请求为简单请求：</p> <p>请求方法为：<b>get</b> | <b>post</b> | <b>head</b> 之一。</p> <p>请求头为：</p> <ul><li>Accept</li> <li>Accept-Language</li> <li>Content-Language</li> <li>Content-Type</li> <li>DPR</li> <li>Downlink</li> <li>Save-Data</li> <li>Viewport-Width</li> <li>Width</li></ul> <p>中的<b>0个或多个</b>。</p> <p>如果存在 Content-Type 请求头，其值只能是以下之一：</p> <ul><li>text/plain</li> <li>multipart/form-data</li> <li>application/x-www-form-urlencoded</li></ul> <p>eg: Client.js （客户端端口在3001）</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>  var xhr = new XMLHttpRequest()
  xhr.open('get','http://localhost:3000/login',true)
  xhr.setRequestHeader('Content-Type', 'text/plain');
  xhr.onload = function(e){
    if(e.currentTarget.status==200){
      alert(e.currentTarget.responseText)
    }
  }
  xhr.send()
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>客户端发起了一个 get 请求，并甚至请求头 Content-Type 字段为 text/plain，属于简单请求。</p> <p>Server.js (端口在3000)</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>  app.get('/login', (req,res) =&gt; {
  res.set('Access-Control-Allow-Origin','*')
  // res.set('Access-Control-Allow-Origin','http://localhost:3001')
  res.send('in get 3000')
})
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>对于简单请求，服务端需要设置响应头 Access-Control-Allow-Origin，'*' 代表支持所有的域访问，也可以具体设置某个域。</p> <p>客户端发起跨域请求后，cors 策略会自动加上 origin 字段的请求头，表示该请求来源于哪个地址。</p> <p>Request Header</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /login HTTP/1.1
Host: localhost:3000
Connection: keep-alive
Pragma: no-cache
Cache-Control: no-cache
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.122 Safari/537.36
Sec-Fetch-Dest: empty
Accept: */*
Origin: http://localhost:3001
Sec-Fetch-Site: same-site
Sec-Fetch-Mode: cors
Referer: http://localhost:3001/
Accept-Encoding: gzip, deflate, br
Accept-Language: zh-CN,zh;q=0.9
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>而服务端设置的响应头就是根据该字段来决定这次跨域请求是否成功，如果Access-Control-Allow-Origin 设置的域和 origin 请求头一致该跨域请求就会成功发送。</p> <h2 id="预检请求"><a href="#预检请求" class="header-anchor">#</a> 预检请求</h2> <p>不属于简单请求的跨域请求都属于预检请求。预检请求会先发送一个 options 请求到服务器，以便于获知是否允许该实际请求，可以避免跨域请求对服务器的用户数据产生未预期的影响。</p> <p>eg: Client.js</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>  var xhr = new XMLHttpRequest()
  xhr.open('put','http://localhost:3000/login',true)
  xhr.setRequestHeader('test', 'text/plain');
  xhr.onload = function(e){
    if(e.currentTarget.status==200){
      alert(e.currentTarget.responseText)
    }
  }
  xhr.send()
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>客户端发起了一个 put 请求，并设置自定义请求头 'test'，属于预检请求。</p> <p>Server.js</p> <p>服务端必须能够处理该路由的 options 请求，并设置 Access-Control-Allow-Origin（必须）、Access-Control-Allow-Methods（必须）、Access-Control-Allow-Headers（非必须） 字段</p> <p>同时 put 方法也要设置 Access-Control-Allow-Origin 的响应头。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>  app.options('/login',function(req,res){
    res.set('Access-Control-Allow-Origin','*')  //必须设置
    res.set('Access-Control-Allow-Methods','PUT') //必须设置
    res.set('Access-Control-Allow-Headers','test') //如果浏览器请求包括Access-Control-Request-Headers字段，则Access-Control-Allow-Headers字段是必需的。
    console.log('xxxxx')
    res.send('optins')
  })

  app.put('/login', (req, res) =&gt; { 
    res.set('Content-Type', 'application/json')
    res.set('Access-Control-Allow-Origin', '*')
    // res.set('Access-Control-Max-Age', '86400')
    console.log('in login')
    res.send('ccccc')
  })
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>预检请求中同时携带了下面两个首部字段：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Access-Control-Request-Method: POST
Access-Control-Request-Headers: X-PINGOTHER, Content-Type
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>首部字段 Access-Control-Request-Method 告知服务器，实际请求将使用 POST 方法。首部字段 Access-Control-Request-Headers 告知服务器，实际请求将携带两个自定义请求首部字段：X-PINGOTHER 与 Content-Type。服务器据此决定，该实际请求是否被允许。</p> <p>put 请求的相应头</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>HTTP/1.1 200 OK
X-Powered-By: Express 
Content-Type: application/json; charset=utf-8
Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: GET
Access-Control-Allow-Headers: test
Content-Length: 5
ETag: W/&quot;5-rtTvO5DXQ5DhJfCLdJEqZbN2CGk&quot;
Date: Mon, 02 Mar 2020 08:07:11 GMT
Connection: keep-alive
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>首部字段 Access-Control-Allow-Methods 表明服务器允许客户端使用 PUT 方法发起请求。</p> <p>首部字段 Access-Control-Allow-Headers 表明服务器允许请求中携带字段 test 。Access-Control-Allow-Methods 一样，Access-Control-Allow-Headers 的值为逗号分割的列表。</p> <h2 id="带-cookie-的预检请求"><a href="#带-cookie-的预检请求" class="header-anchor">#</a> 带 cookie 的预检请求</h2> <p>eg: Client.js</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>  var xhr = new XMLHttpRequest()
  xhr.open('put','http://localhost:3000/login',true)
  xhr.setRequestHeader('test', 'text/plain');
  xhr.withCredentials = true;
  xhr.onload = function(e){
    if(e.currentTarget.status==200){
      alert(e.currentTarget.responseText)
    }
  }
  xhr.send()
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>客户端发起带 cookie 的预检请求，需要设置 xhr 的 withCredentials 属性为true。</p> <p>Server.js</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>  app.options('/login',function(req,res){
    res.set('Access-Control-Allow-Origin','http://localhost:3001')  //必须设置
    res.set('Access-Control-Allow-Methods','PUT') //必须设置
    res.set('Access-Control-Allow-Headers','test')
    res.set('Access-Control-Allow-Credentials', true)
    //如果浏览器请求包括Access-Control-Request-Headers字段，则Access-Control-Allow-Headers字段是必需的。
    console.log('xxxxx')
    res.send('optins')
  })  

  app.put('/login', (req, res) =&gt; { 
    res.set('Content-Type', 'application/json')
    res.set('Access-Control-Allow-Origin', 'http://localhost:3001')
    // res.set('Access-Control-Max-Age', '86400')
    res.set('Access-Control-Allow-Credentials', true)

    console.log('in login')
    res.send('ccccc')
  })
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>服务端必须设置 Access-Control-Allow-Credentials 的响应头 为 true。同时 Access-Control-Allow-Origin 必须设置为指定域。不能为 *。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>想比较 JSONP 来说，cors 跨域支持所有的 http 方法，JSONP 只支持 get 请求，但是 JSONP 的兼容性比较好，支持几乎所有的浏览器，cors 不支持 IE10 以下的浏览器。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/kuayu/jsonp.html" class="prev">
        深入理解 Jsonp
      </a></span> <span class="next"><a href="/blog/kuayu/other.html">
        其他跨域策略
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.e11a16b2.js" defer></script><script src="/assets/js/2.405cebda.js" defer></script><script src="/assets/js/36.95f54780.js" defer></script>
  </body>
</html>
