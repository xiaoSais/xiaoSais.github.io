(window.webpackJsonp=window.webpackJsonp||[]).push([[4],{171:function(s,n,e){s.exports=e.p+"assets/img/app._router.stack.31d5a93d.png"},172:function(s,n,e){s.exports=e.p+"assets/img/b.fb67d8d2.jpg"},204:function(s,n,e){"use strict";e.r(n);var a=[function(){var s=this,n=s.$createElement,a=s._self._c||n;return a("div",{staticClass:"content"},[a("h1",{attrs:{id:"二、express中间件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、express中间件","aria-hidden":"true"}},[s._v("#")]),s._v(" 二、Express中间件")]),s._v(" "),a("h2",{attrs:{id:"中间件是什么"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#中间件是什么","aria-hidden":"true"}},[s._v("#")]),s._v(" 中间件是什么")]),s._v(" "),a("p",[s._v("中间件是在Express请求和相应周期中可以访问请求和相应对象以及下一个中间件的函数。调用next()函数将在该中间件之后下一个执行中间件。")]),s._v(" "),a("p",[s._v("中间件可以执行以下的功能：")]),s._v(" "),a("ul",[a("li",[s._v("执行任何代码")]),s._v(" "),a("li",[s._v("更改请求和相应对象")]),s._v(" "),a("li",[s._v("结束请求-响应周期")]),s._v(" "),a("li",[s._v("调用堆栈中的下一个中间件")])]),s._v(" "),a("p",[s._v("如果当前中间件没有结束请求-相应周期，则必须调用next()将控制权传递给下一个中间件功能，否则，该请求将被挂起。")]),s._v(" "),a("p",[s._v("中间件加载的顺序很重要，首先加载的中间件功能也将首先执行。")]),s._v(" "),a("p",[s._v("一个简单的例子：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("  var express = require('express')\n  var app = express()\n\n  var requestTime = function (req, res, next) {\n    req.requestTime = Date.now()\n    next()\n  }\n\n  app.use(requestTime)\n\n  app.get('/', function (req, res) {\n    var responseText = 'Hello World!<br>'\n    responseText += '<small>Requested at: ' + req.requestTime + '</small>'\n    res.send(responseText)\n  })\n\n  app.listen(3000)\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("p",[s._v("在这个例子里 requestTime 就是一个中间件，在这个例子中，该中间件给req挂载了 requestTime 属性\n执行next()方法，把中间件的控制权交给 app.get()")]),s._v(" "),a("h2",{attrs:{id:"中间件类型"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#中间件类型","aria-hidden":"true"}},[s._v("#")]),s._v(" 中间件类型")]),s._v(" "),a("h3",{attrs:{id:"应用级中间件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#应用级中间件","aria-hidden":"true"}},[s._v("#")]),s._v(" 应用级中间件")]),s._v(" "),a("p",[s._v("通过app.use()函数，挂载到app实例上。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("  // 每次发送请求会打印\n  app.use(function (req, res, next) {\n    console.log('Time:', Date.now())\n    next()\n  })\n  // 访问/login路径的时候会打印，不管发送什么请求\n  app.use('/login',function (req, res, next) {\n    console.log('Time:', Date.now())\n    next()\n  })\n  // 发送get请求且路径为 /login的时候会打印\n  app.get('/login',function (req, res, next) {\n    console.log('Time:', Date.now())\n    next()\n  })\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("h3",{attrs:{id:"路由中间件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#路由中间件","aria-hidden":"true"}},[s._v("#")]),s._v(" 路由中间件")]),s._v(" "),a("p",[s._v("通过app.method()函数，挂载到app实例上。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("  // 发送get请求且路径为 /login的时候会打印\n  app.get('/login',function (req, res, next) {\n    console.log('Time:', Date.now())\n    next()\n  })\n  // 发送post请求的时候执行相应回调\n  app.post('/login', fuunction(req, res, next) {\n    console.log('Time:', Date.now())\n    next()\n  })\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("h3",{attrs:{id:"错误处理中间件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#错误处理中间件","aria-hidden":"true"}},[s._v("#")]),s._v(" 错误处理中间件")]),s._v(" "),a("p",[s._v("中间件传递四个参数")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("app.use(function (err, req, res, next) {\n  console.error(err.stack)\n  res.status(500).send('Something broke!')\n})\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h3",{attrs:{id:"内置中间件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#内置中间件","aria-hidden":"true"}},[s._v("#")]),s._v(" 内置中间件")]),s._v(" "),a("p",[s._v("express.static() | express.json() | express.urlencoded() | express.Router()")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("  app.use(express.static('dist'))\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"第三方中间件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#第三方中间件","aria-hidden":"true"}},[s._v("#")]),s._v(" 第三方中间件")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("  var express = require('express')\n  var app = express()\n  var cookieParser = require('cookie-parser')\n\n  // load the cookie-parsing middleware\n  app.use(cookieParser())\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("h2",{attrs:{id:"中间件原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#中间件原理","aria-hidden":"true"}},[s._v("#")]),s._v(" 中间件原理")]),s._v(" "),a("p",[s._v("中间件的核心要搞懂app.use() && app.method() 到底做了什么。在构造函数一节中，app继承自 proto， proto定义在 /lib/application.js 文件下。该文件定义了所有挂载到app实例上的方法，比如app.method() || app.use() || app.listen()")]),s._v(" "),a("h3",{attrs:{id:"app-use"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#app-use","aria-hidden":"true"}},[s._v("#")]),s._v(" app.use()")]),s._v(" "),a("p",[s._v("application.js line 199行有该函数的定义：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("  app.use = function use(fn) {\n    // 确定取函数参数的位置\n    var offset = 0;\n    var path = '/';\n\n    // default path to '/'\n    // disambiguate app.use([fn])\n    // 兼容两种模式 app.use([fn])\n    if (typeof fn !== 'function') {\n      var arg = fn;\n\n      while (Array.isArray(arg) && arg.length !== 0) {\n        arg = arg[0];\n      }\n\n      // first arg is the path\n      if (typeof arg !== 'function') {\n        offset = 1;\n        path = fn;\n      }\n    }\n    // 获取所有的中间件函数，如果有path的话，从第二位参数往后拿到所有函数，否则从第一个往后拿到所有函数\n    var fns = flatten(slice.call(arguments, offset));\n\n    if (fns.length === 0) {\n      throw new TypeError('app.use() requires a middleware function')\n    }\n    ...\n  }\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br")])]),a("p",[s._v("这一部分代码是对app.use()函数的参数处理部分，从代码可以看出，app.use()其实也支持app.use([path, fn])这样的传参，这里定义了一个offset变量以便于在有无path的情况下均能正确拿到所有的中间件函数。slice指向的是 Array.prototype.slice。flatten是对目标的深拷贝。这段代码最后拿到了 fns，一个由中间件函数组成的数组。")]),s._v(" "),a("p",[s._v("application.js line 228 初始化路由参数")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("  this.lazyrouter();\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("application.js line 146")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("  app.lazyrouter = function lazyrouter() {\n    // 初始化router实例并挂载到this._router上\n    if (!this._router) {\n      this._router = new Router({\n        caseSensitive: this.enabled('case sensitive routing'),\n        strict: this.enabled('strict routing')\n      });\n\n      this._router.use(query(this.get('query parser fn')));\n      this._router.use(middleware.init(this));\n    }\n  };\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("p",[s._v("初始化router的时候传入了两个默认的中间件，这两个中间件没有任何path,代表任何路径都会匹配到，query()和middleware()这两个中间件的作用是什么呢？")]),s._v(" "),a("p",[s._v("/lib/middleware/query.js")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("  module.exports = function query(options) {\n    var opts = merge({}, options)\n    // qs.parse => key=value => {key: value}\n    var queryparse = qs.parse;\n    \n    // options可以传function，此时 queryparse 为qs.parse(str, { allowPrototype: true});\n    if (typeof options === 'function') {\n      queryparse = options;\n      opts = undefined;\n    }\n    // 不是函数的话手动设置opts.allowPrototypes 为true\n    if (opts !== undefined && opts.allowPrototypes === undefined) {\n      // back-compat for qs module\n      opts.allowPrototypes = true;\n    }\n\n    return function query(req, res, next){\n      if (!req.query) {\n        // req.query => Object的类型\n        var val = parseUrl(req).query;\n        req.query = queryparse(val, opts);\n      }\n\n      next();\n    };\n  };\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br")])]),a("p",[s._v("由以上代码可以看出query()中间件的作用是将请求的url参数比如：/path?id=2 转化成{id: 2}，并挂载到req.query属性上。转化用了 qs.parse()方法。")]),s._v(" "),a("p",[s._v("/lib/middleware/init.js line28")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("  exports.init = function(app){\n    return function expressInit(req, res, next){\n      if (app.enabled('x-powered-by')) res.setHeader('X-Powered-By', 'Express');\n      req.res = res;\n      res.req = req;\n      req.next = next;\n\n      setPrototypeOf(req, app.request)\n      setPrototypeOf(res, app.response)\n\n      res.locals = res.locals || Object.create(null);\n\n      next();\n    };\n  };\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("p",[s._v("middleware.init(this) 初始化中间件，设置响应头 X-Powered-By 为express，将res挂载到req上，req挂载到res上。（这样做的目的是什么？）。")]),s._v(" "),a("p",[s._v("application.js line 228 - 237")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("  app.use = function use(fn) {\n    ...\n    this.lazyrouter();\n    var router = this._router;\n\n    fns.forEach(function (fn) {\n      // non-express app\n      if (!fn || !fn.handle || !fn.set) {\n        // 执行 router 的use方法\n        return router.use(path, fn);\n      }\n    }\n    ... \n  }\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("p",[s._v("拿到fns也就是所有中间件函数组成的数组后，它会逐个遍历，然后判断fn是否有handle属性和set属性，如果有的话，就默认是express app，否则就是非express app，如果不是express app，那么就将path，和fn传入到router.use()里。router就是之前刚刚初始化的router实例。（假如一个自定义中间件有handle和set属性也是自定义的，它是不是也就走到express app分支里了？），这里的关键是router.use()方法。")]),s._v(" "),a("p",[s._v("/lib/router/index.js line 43 - 60")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("  var proto = module.exports = function(options) {\n    var opts = options || {};\n\n    function router(req, res, next) {\n      router.handle(req, res, next);\n    }\n\n    // mixin Router class functions\n    setPrototypeOf(router, proto)\n\n    router.params = {};\n    router._params = [];\n    router.caseSensitive = opts.caseSensitive;\n    router.mergeParams = opts.mergeParams;\n    router.strict = opts.strict;\n    router.stack = [];\n\n    return router;\n  };\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("p",[s._v("router的构造函数，new Router() 之后返回一个router对象，这个对象挂载了一系列属性，比较重要的是stack属性，用来存layer的。")]),s._v(" "),a("p",[s._v("/lib/router/index.js line 454 - 475")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("  proto.use = function use(fn) {\n    ...\n\n    for (var i = 0; i < callbacks.length; i++) {\n      var fn = callbacks[i];\n\n      if (typeof fn !== 'function') {\n        throw new TypeError('Router.use() requires a middleware function but got a ' + gettype(fn))\n      }\n\n      // add the middleware\n      debug('use %o %s', path, fn.name || '<anonymous>')\n      // 创建layer\n      var layer = new Layer(path, {\n        sensitive: this.caseSensitive,\n        strict: false,\n        end: false\n      }, fn);\n      // 如果是普通中间件 layer.route 置为undefined\n      layer.route = undefined;\n      // 将layer保存到router.stack里\n      this.stack.push(layer);\n    }\n    return this;\n  };\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br")])]),a("p",[s._v("router.use()前半部分也是参数处理，和app.use()一样，最后拿到callbacks也就是中间件函数数组，遍历之后针对每一个fn创建一个layer对象，并把layer对象保存到router.stack里，该stack是在构造函数里定义的。")]),s._v(" "),a("p",[s._v("/lib/router/layer.js")]),s._v(" "),a("p",[s._v("该文件定义了layer的构造函数，错误中间件 | 普通中间件的处理，以及layer的匹配方法。")]),s._v(" "),a("h3",{attrs:{id:"app-method"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#app-method","aria-hidden":"true"}},[s._v("#")]),s._v(" app.method()")]),s._v(" "),a("p",[s._v("app.method() 也就是app.get() | app.post() 等方法的总称。")]),s._v(" "),a("p",[s._v("/lib/application.js line 490 - 502")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("  methods.forEach(function(method){\n    app[method] = function(path){\n      if (method === 'get' && arguments.length === 1) {\n        // app.get(setting)\n        return this.set(path);\n      }\n\n      this.lazyrouter();\n\n      var route = this._router.route(path);\n      route[method].apply(route, slice.call(arguments, 1));\n      return this;\n    };\n});\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("p",[s._v("这段代码主要是创建route实例，然后执行相应的route[method]方法。我们看下router.route()方法做了什么。")]),s._v(" "),a("p",[s._v("/lib/router/index.js line 491 - 504")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("  proto.route = function route(path) {\n    var route = new Route(path);\n    // 创建layer对象\n    var layer = new Layer(path, {\n      sensitive: this.caseSensitive,\n      strict: this.strict,\n      end: true\n    }, route.dispatch.bind(route));\n\n    // layer.route 属性置为route\n    layer.route = route;\n    // layer 放到stack里\n    this.stack.push(layer);\n    return route;\n  };\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("p",[s._v("router.route 会先创建一个 route 对象，然后再创建一个 layer，layer 的 route 属性指向 route 对象，这一点和app.use()不同，然后也是将layer放到router.stack数组里。")]),s._v(" "),a("p",[s._v("/lib/router/route.js line 43 - 51")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("  function Route(path) {\n    this.path = path;\n    this.stack = [];\n\n    debug('new %o', path)\n\n    // route handlers for various http methods\n    this.methods = {};\n  }\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("route实例的构造函数，route实例有三个属性，path通过 router.route(path) 传递进来，stack不同于router中的stack，methods是干啥的？")]),s._v(" "),a("p",[s._v("route.js line 192 - 216")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("  methods.forEach(function(method){ \n    Route.prototype[method] = function(){\n      var handles = flatten(slice.call(arguments));\n\n      for (var i = 0; i < handles.length; i++) {\n        var handle = handles[i];\n\n        if (typeof handle !== 'function') {\n          var type = toString.call(handle);\n          var msg = 'Route.' + method + '() requires a callback function but got a ' + type\n          throw new Error(msg);\n        }\n\n        debug('%s %o', method, this.path)\n\n        var layer = Layer('/', {}, handle);\n        layer.method = method;\n\n        this.methods[method] = true;\n        this.stack.push(layer);\n      }\n\n      return this;\n    };\n  });\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br")])]),a("p",[s._v("在route里执行相应的Method方法，其实也创建一个layer，每一个layer对应一个中间件函数，最后push到route.stack里。")]),s._v(" "),a("h3",{attrs:{id:"梳理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#梳理","aria-hidden":"true"}},[s._v("#")]),s._v(" 梳理")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("  var requestTime = function (req, res, next) {\n    req.requestTime = Date.now()\n    next()\n  }\n  app.use(express.static('dist'))\n\n  app.use(requestTime)\n\n  app.post('/helo', function (req, res) {\n    console.log(req.query)\n    var responseText = 'Hello World!<br>'\n    responseText += '<small>Requested at: ' + req.requestTime + '</small>'\n    res.send(responseText)\n  })\n\n  \n  app.listen(3000)\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("p",[s._v("在这里例子中用了三个中间件，加上初始化两个中间件，一共五个中间件。示例图如下：")]),s._v(" "),a("p",[a("img",{attrs:{src:e(171),alt:"solar"}})]),s._v(" "),a("p",{staticStyle:{"text-align":"center"}},[s._v("中间件示例图")]),s._v(" "),a("h3",{attrs:{id:"匹配"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#匹配","aria-hidden":"true"}},[s._v("#")]),s._v(" 匹配")]),s._v(" "),a("p",[s._v("中间件函数被存到layer里，那么这些中间件函数是如何触发的呢？")]),s._v(" "),a("p",[s._v("appliction.js 634 - 637")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("  app.listen = function listen() {\n    var server = http.createServer(this);\n    return server.listen.apply(server, arguments);\n  };\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("app实例作为 http.createServer 的回调，每次有请求进来都会执行 app()。")]),s._v(" "),a("p",[s._v("express.js 37 - 40")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("function createApplication() {\n  var app = function(req, res, next) {\n    app.handle(req, res, next);\n  };\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("app也是一个函数，执行app(req, res, next) 也就是执行app.handle()")]),s._v(" "),a("p",[s._v("appliction.js 168 - 185")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("  app.handle = function handle(req, res, callback) {\n    var router = this._router;\n\n    // final handler\n    var done = callback || finalhandler(req, res, {\n      env: this.get('env'),\n      onerror: logerror.bind(this)\n    });\n\n    // no routes\n    if (!router) {\n      debug('no routes defined on app');\n      done();\n      return;\n    }\n\n    router.handle(req, res, done);\n  };\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])]),a("p",[s._v("app.handle 针对app上不存在_router的情况做了特殊处理，最后调用了app._router.handle。")]),s._v(" "),a("p",[s._v("/lib/router/index.js line 219 - 257")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("proto.handle = function handle(req, res, out) {\n  ...\n  var layer;\n  var match;\n  var route;\n  while (match !== true && idx < stack.length) {\n    layer = stack[idx++];\n    match = matchLayer(layer, path);\n    route = layer.route;\n\n    if (typeof match !== 'boolean') {\n      // hold on to layerError\n      layerError = layerError || match;\n    }\n\n    if (match !== true) {\n      continue;\n    }\n\n    if (!route) {\n      // process non-route handlers normally\n      continue;\n    }\n\n    if (layerError) {\n      // routes do not match with a pending error\n      match = false;\n      continue;\n    }\n\n    var method = req.method;\n    var has_method = route._handles_method(method);\n\n    // build up automatic options response\n    if (!has_method && method === 'OPTIONS') {\n      appendMethods(options, route._options());\n    }\n\n    // don't even bother matching route\n    if (!has_method && method !== 'HEAD') {\n      match = false;\n      continue;\n    }\n  }\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br")])]),a("p",[s._v("循环终止条件是匹配不到path，并且计数器大于_router.stack.length, 先调用 matchLayer 函数对 layer 和 path 进行匹配，matchLayer 实际上调用的是 Layer.prototype.match 方法，该方法通过挂载到layer.regexp上的正则和 path进行匹配，最后返回true或者false，匹配成功的话还会解析param挂载到layer.params上。")]),s._v(" "),a("p",[s._v("循环里主要处理路由中间件的情况，我们知道路由中间件的 layer.route 指向的是一个route实例，应用级别的中间件指向的是undefined，当是路由中间件的情况下，会调用 Route.prototype._handles_method() 方法，该方法的定义在 /lib/router/route.js里。该方法返回 true 或者 false，代表传入的参数是否是支持的 http 方法。如果 http 请求是options，它会将Express支持的请求方式转化成数组存放在options里。")]),s._v(" "),a("p",[s._v("/lib/router/index.js line 276 - 286")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("  self.process_params(layer, paramcalled, req, res, function (err) {\n    if (err) {\n      return next(layerError || err);\n    }\n\n    if (route) {\n      return layer.handle_request(req, res, next);\n    }\n\n    trim_prefix(layer, layerError, layerPath, path);\n  });\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("路由匹配成功且为路由级别的中间件，执行 Layer.prototype.handle_request() 方法，否则调用trim_prefix() 标准化req.url | req.baseUrl，最后再调用 Layer.prototype.handle_request() 方法。")]),s._v(" "),a("p",[s._v("/lib/router/layer.js line 86 - 99")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("  Layer.prototype.handle_request = function handle(req, res, next) {\n    var fn = this.handle;\n\n    if (fn.length > 3) {\n      // not a standard request handler\n      return next();\n    }\n\n    try {\n      fn(req, res, next);\n    } catch (err) {\n      next(err);\n    }\n} ;\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("p",[s._v("如果参数大于三个跳过，否则执行layer.handle上挂载的中间件函数，执行完毕调用 next() 函数，将路由控制权交给下一个中间件。")]),s._v(" "),a("h3",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结","aria-hidden":"true"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),a("p",[a("img",{attrs:{src:e(172),alt:"solar"}})]),s._v(" "),a("p",{staticStyle:{"text-align":"center"}},[s._v("路由匹配")])])}],t=e(0),r=Object(t.a)({},function(){this.$createElement;this._self._c;return this._m(0)},a,!1,null,null,null);r.options.__file="middle.md";n.default=r.exports}}]);