(window.webpackJsonp=window.webpackJsonp||[]).push([[34],{206:function(s,e,n){"use strict";n.r(e);var t=n(0),a=Object(t.a)({},function(){this.$createElement;this._self._c;return this._m(0)},[function(){var s=this,e=s.$createElement,n=s._self._c||e;return n("div",{staticClass:"content"},[n("h1",{attrs:{id:"跨域资源共享（cors）"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#跨域资源共享（cors）","aria-hidden":"true"}},[s._v("#")]),s._v(" 跨域资源共享（cors）")]),s._v(" "),n("h2",{attrs:{id:"简介"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#简介","aria-hidden":"true"}},[s._v("#")]),s._v(" 简介")]),s._v(" "),n("p",[s._v("首先 cors 是在 IE 10 + 浏览器上才可以工作。"),n("b",[s._v("并且前端不用做任何改造。")]),s._v(" cors 允许你跨域去访问一个接口，只是后端要做些许调整。cors 将 client 的http 请求分为两种 简单请求 && 预检请求。")]),s._v(" "),n("h2",{attrs:{id:"简单请求"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#简单请求","aria-hidden":"true"}},[s._v("#")]),s._v(" 简单请求")]),s._v(" "),n("p",[s._v("符合以下条件的请求为简单请求：")]),s._v(" "),n("p",[s._v("请求方法为："),n("b",[s._v("get")]),s._v(" | "),n("b",[s._v("post")]),s._v(" | "),n("b",[s._v("head")]),s._v(" 之一。")]),s._v(" "),n("p",[s._v("请求头为：")]),s._v(" "),n("ul",[n("li",[s._v("Accept")]),s._v(" "),n("li",[s._v("Accept-Language")]),s._v(" "),n("li",[s._v("Content-Language")]),s._v(" "),n("li",[s._v("Content-Type")]),s._v(" "),n("li",[s._v("DPR")]),s._v(" "),n("li",[s._v("Downlink")]),s._v(" "),n("li",[s._v("Save-Data")]),s._v(" "),n("li",[s._v("Viewport-Width")]),s._v(" "),n("li",[s._v("Width")])]),s._v(" "),n("p",[s._v("中的"),n("b",[s._v("0个或多个")]),s._v("。")]),s._v(" "),n("p",[s._v("如果存在 Content-Type 请求头，其值只能是以下之一：")]),s._v(" "),n("ul",[n("li",[s._v("text/plain")]),s._v(" "),n("li",[s._v("multipart/form-data")]),s._v(" "),n("li",[s._v("application/x-www-form-urlencoded")])]),s._v(" "),n("p",[s._v("eg: Client.js （客户端端口在3001）")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("  var xhr = new XMLHttpRequest()\n  xhr.open('get','http://localhost:3000/login',true)\n  xhr.setRequestHeader('Content-Type', 'text/plain');\n  xhr.onload = function(e){\n    if(e.currentTarget.status==200){\n      alert(e.currentTarget.responseText)\n    }\n  }\n  xhr.send()\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("p",[s._v("客户端发起了一个 get 请求，并甚至请求头 Content-Type 字段为 text/plain，属于简单请求。")]),s._v(" "),n("p",[s._v("Server.js (端口在3000)")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("  app.get('/login', (req,res) => {\n  res.set('Access-Control-Allow-Origin','*')\n  // res.set('Access-Control-Allow-Origin','http://localhost:3001')\n  res.send('in get 3000')\n})\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("对于简单请求，服务端需要设置响应头 Access-Control-Allow-Origin，'*' 代表支持所有的域访问，也可以具体设置某个域。")]),s._v(" "),n("p",[s._v("客户端发起跨域请求后，cors 策略会自动加上 origin 字段的请求头，表示该请求来源于哪个地址。")]),s._v(" "),n("p",[s._v("Request Header")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("GET /login HTTP/1.1\nHost: localhost:3000\nConnection: keep-alive\nPragma: no-cache\nCache-Control: no-cache\nUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.122 Safari/537.36\nSec-Fetch-Dest: empty\nAccept: */*\nOrigin: http://localhost:3001\nSec-Fetch-Site: same-site\nSec-Fetch-Mode: cors\nReferer: http://localhost:3001/\nAccept-Encoding: gzip, deflate, br\nAccept-Language: zh-CN,zh;q=0.9\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("p",[s._v("而服务端设置的响应头就是根据该字段来决定这次跨域请求是否成功，如果Access-Control-Allow-Origin 设置的域和 origin 请求头一致该跨域请求就会成功发送。")]),s._v(" "),n("h2",{attrs:{id:"预检请求"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#预检请求","aria-hidden":"true"}},[s._v("#")]),s._v(" 预检请求")]),s._v(" "),n("p",[s._v("不属于简单请求的跨域请求都属于预检请求。预检请求会先发送一个 options 请求到服务器，以便于获知是否允许该实际请求，可以避免跨域请求对服务器的用户数据产生未预期的影响。")]),s._v(" "),n("p",[s._v("eg: Client.js")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("  var xhr = new XMLHttpRequest()\n  xhr.open('put','http://localhost:3000/login',true)\n  xhr.setRequestHeader('test', 'text/plain');\n  xhr.onload = function(e){\n    if(e.currentTarget.status==200){\n      alert(e.currentTarget.responseText)\n    }\n  }\n  xhr.send()\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("p",[s._v("客户端发起了一个 put 请求，并设置自定义请求头 'test'，属于预检请求。")]),s._v(" "),n("p",[s._v("Server.js")]),s._v(" "),n("p",[s._v("服务端必须能够处理该路由的 options 请求，并设置 Access-Control-Allow-Origin（必须）、Access-Control-Allow-Methods（必须）、Access-Control-Allow-Headers（非必须） 字段")]),s._v(" "),n("p",[s._v("同时 put 方法也要设置 Access-Control-Allow-Origin 的响应头。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("  app.options('/login',function(req,res){\n    res.set('Access-Control-Allow-Origin','*')  //必须设置\n    res.set('Access-Control-Allow-Methods','PUT') //必须设置\n    res.set('Access-Control-Allow-Headers','test') //如果浏览器请求包括Access-Control-Request-Headers字段，则Access-Control-Allow-Headers字段是必需的。\n    console.log('xxxxx')\n    res.send('optins')\n  })\n\n  app.put('/login', (req, res) => { \n    res.set('Content-Type', 'application/json')\n    res.set('Access-Control-Allow-Origin', '*')\n    // res.set('Access-Control-Max-Age', '86400')\n    console.log('in login')\n    res.send('ccccc')\n  })\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])]),n("p",[s._v("预检请求中同时携带了下面两个首部字段：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("Access-Control-Request-Method: POST\nAccess-Control-Request-Headers: X-PINGOTHER, Content-Type\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("首部字段 Access-Control-Request-Method 告知服务器，实际请求将使用 POST 方法。首部字段 Access-Control-Request-Headers 告知服务器，实际请求将携带两个自定义请求首部字段：X-PINGOTHER 与 Content-Type。服务器据此决定，该实际请求是否被允许。")]),s._v(" "),n("p",[s._v("put 请求的相应头")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('HTTP/1.1 200 OK\nX-Powered-By: Express \nContent-Type: application/json; charset=utf-8\nAccess-Control-Allow-Origin: *\nAccess-Control-Allow-Methods: GET\nAccess-Control-Allow-Headers: test\nContent-Length: 5\nETag: W/"5-rtTvO5DXQ5DhJfCLdJEqZbN2CGk"\nDate: Mon, 02 Mar 2020 08:07:11 GMT\nConnection: keep-alive\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[s._v("首部字段 Access-Control-Allow-Methods 表明服务器允许客户端使用 PUT 方法发起请求。")]),s._v(" "),n("p",[s._v("首部字段 Access-Control-Allow-Headers 表明服务器允许请求中携带字段 test 。Access-Control-Allow-Methods 一样，Access-Control-Allow-Headers 的值为逗号分割的列表。")]),s._v(" "),n("h2",{attrs:{id:"带-cookie-的预检请求"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#带-cookie-的预检请求","aria-hidden":"true"}},[s._v("#")]),s._v(" 带 cookie 的预检请求")]),s._v(" "),n("p",[s._v("eg: Client.js")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("  var xhr = new XMLHttpRequest()\n  xhr.open('put','http://localhost:3000/login',true)\n  xhr.setRequestHeader('test', 'text/plain');\n  xhr.withCredentials = true;\n  xhr.onload = function(e){\n    if(e.currentTarget.status==200){\n      alert(e.currentTarget.responseText)\n    }\n  }\n  xhr.send()\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[s._v("客户端发起带 cookie 的预检请求，需要设置 xhr 的 withCredentials 属性为true。")]),s._v(" "),n("p",[s._v("Server.js")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("  app.options('/login',function(req,res){\n    res.set('Access-Control-Allow-Origin','http://localhost:3001')  //必须设置\n    res.set('Access-Control-Allow-Methods','PUT') //必须设置\n    res.set('Access-Control-Allow-Headers','test')\n    res.set('Access-Control-Allow-Credentials', true)\n    //如果浏览器请求包括Access-Control-Request-Headers字段，则Access-Control-Allow-Headers字段是必需的。\n    console.log('xxxxx')\n    res.send('optins')\n  })  \n\n  app.put('/login', (req, res) => { \n    res.set('Content-Type', 'application/json')\n    res.set('Access-Control-Allow-Origin', 'http://localhost:3001')\n    // res.set('Access-Control-Max-Age', '86400')\n    res.set('Access-Control-Allow-Credentials', true)\n\n    console.log('in login')\n    res.send('ccccc')\n  })\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br")])]),n("p",[s._v("服务端必须设置 Access-Control-Allow-Credentials 的响应头 为 true。同时 Access-Control-Allow-Origin 必须设置为指定域。不能为 *。")]),s._v(" "),n("h2",{attrs:{id:"总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#总结","aria-hidden":"true"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),n("p",[s._v("想比较 JSONP 来说，cors 跨域支持所有的 http 方法，JSONP 只支持 get 请求，但是 JSONP 的兼容性比较好，支持几乎所有的浏览器，cors 不支持 IE10 以下的浏览器。")])])}],!1,null,null,null);a.options.__file="cors.md";e.default=a.exports}}]);